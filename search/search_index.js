var __index = {"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"index.html","title":"My Learning Notes","text":"<p>Welcome to my learning notes.</p> <p>I'm focusing on Linux, Bash Scripting, Python Scripting, Docker and Kubernetes.</p>"},{"location":"Docker/ComposeFiles/vaultwarden.html","title":"Installing Vaultwarden via Docker","text":""},{"location":"Docker/ComposeFiles/vaultwarden.html#1-install-docker","title":"1. Install Docker","text":"<p>Install Docker on your system first.</p>"},{"location":"Docker/ComposeFiles/vaultwarden.html#2-pull-docker-images","title":"2. Pull Docker Images","text":"<ul> <li>vaultwarden/server:1.33.2</li> <li>openresty/openresty:bookworm</li> </ul> <pre><code>mkdir -p /home/vaultwarden /home/openresty/{ssl,conf.d}\n</code></pre>"},{"location":"Docker/ComposeFiles/vaultwarden.html#3-vaultwarden-setup","title":"3. Vaultwarden Setup","text":""},{"location":"Docker/ComposeFiles/vaultwarden.html#create-a-dedicated-vaultwarden-network-to-avoid-direct-exposure","title":"Create a dedicated Vaultwarden network to avoid direct exposure","text":"<pre><code>docker network create --driver bridge vaultwarden_network\n</code></pre>"},{"location":"Docker/ComposeFiles/vaultwarden.html#create-the-vaultwarden-startup-file-at-homevaultwardencomposeyml","title":"Create the Vaultwarden startup file at /home/vaultwarden/compose.yml","text":"<pre><code>services:\n  vaultwarden:\n    image: vaultwarden/server:1.33.2\n    container_name: vaultwarden\n    restart: unless-stopped\n    environment:\n      TZ: Asia/Shanghai\n      ENABLE_WEBSOCKET: false\n      # SIGNUPS_ALLOWED: false # Disable new user registration\n      SIGNUPS_ALLOWED: true # Allow new user registration\n      # ADMIN_TOKEN: Argon2 PHC hashed password for /admin access\n      # Generate using: echo -n \"YourPassword\" | argon2 \"$(openssl rand -base64 32)\" -e -id -k 65540 -t 3 -p 4\n      # Or use: docker run --rm -it vaultwarden/server /vaultwarden hash\n      ADMIN_TOKEN: xxx\n    volumes:\n      - ./vw-data:/data\n    networks:\n      - vaultwarden_network\nnetworks:\n  vaultwarden_network:\n    external: true\n</code></pre>"},{"location":"Docker/ComposeFiles/vaultwarden.html#start-vaultwarden","title":"Start Vaultwarden","text":"<pre><code>cd /home/vaultwarden\ndocker compose up -d\n</code></pre>"},{"location":"Docker/ComposeFiles/vaultwarden.html#4-generate-an-ssl-certificate","title":"4. Generate an SSL Certificate","text":"<pre><code>cd /home/openresty/ssl\n# Generate private key\nopenssl ecparam -name prime256v1 -genkey -noout -out key.pem\n# Create certificate signing request\nopenssl req -new -key key.pem -out server.csr \\\n    -subj \"/CN=localhost\"\n# Generate self-signed certificate\nopenssl x509 -req -in server.csr -signkey key.pem -out cert.pem -days 3650\n</code></pre>"},{"location":"Docker/ComposeFiles/vaultwarden.html#5-openresty-setup","title":"5. OpenResty Setup","text":""},{"location":"Docker/ComposeFiles/vaultwarden.html#configure-homeopenrestynginxconf","title":"Configure /home/openresty/nginx.conf","text":"<pre><code>pcre_jit on;\nworker_processes auto;\nevents {\n    worker_connections 1024;\n}\nhttp {\n    log_format main '$remote_addr - $remote_user [$time_iso8601] \"$request\" '\n    '$status $body_bytes_sent \"$http_referer\" '\n    '\"$http_user_agent\" \"$http_x_forwarded_for\"'\n    '\"$request_time\" \"$upstream_response_time\"';\n    open_log_file_cache max=1024 inactive=1m valid=5m min_uses=2;\n    access_log /var/log/nginx/access.log main;\n    error_log /var/log/nginx/error.log debug;\n    underscores_in_headers off;\n    include mime.types;\n    default_type application/octet-stream;\n    client_body_temp_path /var/run/openresty/nginx-client-body;\n    proxy_temp_path /var/run/openresty/nginx-proxy;\n    fastcgi_temp_path /var/run/openresty/nginx-fastcgi;\n    uwsgi_temp_path /var/run/openresty/nginx-uwsgi;\n    scgi_temp_path /var/run/openresty/nginx-scgi;\n    sendfile on;\n    keepalive_timeout 65;\n    server_tokens off;\n    resolver 127.0.0.11 valid=30s;\n    types_hash_max_size 4096;\n    client_max_body_size 1024M;\n    client_body_timeout 1m;\n    proxy_connect_timeout 1m;\n    proxy_read_timeout 10m;\n    proxy_send_timeout 10m;\n    include /etc/nginx/conf.d/*.conf;\n}\n</code></pre>"},{"location":"Docker/ComposeFiles/vaultwarden.html#configure-homeopenrestyconfdvaultwardenconf","title":"Configure /home/openresty/conf.d/vaultwarden.conf","text":"<pre><code>upstream vaultwarden-default {\n    zone vaultwarden-default 64k;\n    server vaultwarden:80;\n    keepalive 2;\n}\nmap $http_upgrade $connection_upgrade {\n    default upgrade;\n    '' \"\";\n}\nserver {\n    listen 80;\n    return 301 https://$host$request_uri;\n}\nserver {\n    listen 443 ssl;\n    http2 on;\n    server_name _;\n    ssl_certificate /etc/nginx/ssl/cert.pem;\n    ssl_certificate_key /etc/nginx/ssl/key.pem;\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_prefer_server_ciphers off;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 1h;\n    client_max_body_size 525M;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection $connection_upgrade;\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    proxy_connect_timeout 777;\n    proxy_send_timeout 777;\n    proxy_read_timeout 777;\n    send_timeout 777;\n    location / {\n      proxy_pass http://vaultwarden-default;\n    }\n}\n</code></pre>"},{"location":"Docker/ComposeFiles/vaultwarden.html#configure-homeopenrestycomposeyml","title":"Configure /home/openresty/compose.yml","text":"<pre><code>services:\n  openresty:\n    image: openresty/openresty:bookworm\n    container_name: openresty\n    restart: unless-stopped\n    environment:\n      - TZ=Asia/Shanghai\n    ports:\n      - \"80:80\"\n      - \"443:443\"\n    volumes:\n      - ./nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro\n      - ./conf.d:/etc/nginx/conf.d/:ro\n      - ./default.d/:/etc/nginx/default.d/:ro\n      - ./log:/var/log/nginx/:rw\n      - ./ssl:/etc/nginx/ssl/:ro\n      - ./socks:/var/run/socks\n    networks:\n      - vaultwarden_network\nnetworks:\n  vaultwarden_network:\n    external: true\n    driver: bridge\n</code></pre>"},{"location":"Docker/ComposeFiles/vaultwarden.html#start-openresty","title":"Start OpenResty","text":"<pre><code>cd /home/openresty\ndocker compose up -d\n</code></pre>"},{"location":"Docker/ComposeFiles/vaultwarden.html#6-access-vaultwarden","title":"6. Access Vaultwarden","text":"<ul> <li>User interface: https://ip/</li> <li>Admin panel: https://ip/admin, password: <code>Password used to generated ADMIN_TOKEN</code></li> </ul>"},{"location":"Docker/ComposeFiles/vaultwarden.html#7-toggle-new-user-registration","title":"7. Toggle New User Registration","text":"<p>To enable/disable new user registration: 1. Modify <code>/home/vaultwarden/compose.yml</code>: toggle the <code>SIGNUPS_ALLOWED</code> value 2. Restart Vaultwarden: <code>docker compose restart</code></p> <p>Users can be managed through the admin interface.</p>"},{"location":"Docker/ComposeFiles/vaultwarden.html#8-browser-setup","title":"8. Browser Setup","text":"<p>Install the Bitwarden browser extension to start using Vaultwarden.</p>"},{"location":"Linux/ssh.html","title":"ssh","text":""},{"location":"Linux/ssh.html#opening-software-on-a-remote-server-via-x11","title":"Opening Software on a Remote Server via X11","text":""},{"location":"Linux/ssh.html#on-the-server-x11-server","title":"On the server (X11-SERVER)","text":"<pre><code># Install necessary packages\nyum install -y xorg-x11-xauth\n# This is a rough implementation;\n# Should use sed for a more precisec onfiguration.\necho \"unset LIBGL_ALWAYS_INDIRECT\" &gt;&gt; ~/.bashrc\necho \"export DISPLAY=:0.0\" &gt;&gt; ~/.bashrc\nsudo bash -c \"echo 'X11Forwarding yes\nX11UseLocalhost no\nX11DisplayOffset 10' &gt;&gt; /etc/ssh/sshd_config\"\nsudo systemctl restart sshd\n</code></pre>"},{"location":"Linux/ssh.html#on-the-client-x11-client","title":"On the client (X11-CLIENT)","text":"<pre><code>ssh -XYT \"${X11-SERVER-IP}\" xclock\n</code></pre>"},{"location":"Linux/ssh.html#compiling-openssh-with-musl","title":"Compiling OpenSSH with musl","text":"<p>Updating OpenSSH on a Linux host is a common task. According to CVE-2024-6387, this security risk affects many openssh-server compiled with glibc. In this article, I will try to compile a static OpenSSH on Alpine Linux and see whether it can run properly on RHEL.</p>"},{"location":"Linux/ssh.html#requirements","title":"Requirements","text":"<ul> <li>musl, pre-installed on Alpine Linux.</li> <li>openssh-9.8p1</li> <li>Other system packages: see below</li> </ul>"},{"location":"Linux/ssh.html#steps","title":"Steps","text":""},{"location":"Linux/ssh.html#1-install-required-system-packages","title":"1. Install Required System Packages","text":"<pre><code>apk update &amp;&amp; apk upgrade &amp;&amp; apk add autoconf build-base linux-headers linux-pam-dev zlib-dev openssl-dev zlib-static musl-dev openssl-libs-static\n</code></pre>"},{"location":"Linux/ssh.html#2-download-source-code-packages","title":"2. Download Source Code Packages","text":"<p>Download the source code packages to the /tmp/src/ directory.</p>"},{"location":"Linux/ssh.html#3-compile-openssh","title":"3. Compile openssh","text":"<pre><code>rm -rf /tmp/openssh_src/\nmkdir -p /tmp/openssh_src/\ntar xf \"${SRC_DIR}/${openssh_package}\" \\\n   -C /tmp/openssh_src/ \\\n   --strip-components 1\ncd /tmp/openssh_src/ || exit 99\n(\n   autoconf\n   ./configure --prefix=\"${PREFIX_DIR}\" \\\n      --sysconfdir=/etc/ssh \\\n      --with-zlib \\\n      --with-ssl-dir=/usr/include/openssl \\\n      --with-ldflags=-static\n      make -j \"$(($(nproc) + 1))\" &amp;&amp;\n      make install\n) 2&gt;&amp;1 | tee /tmp/compile_openssh.log\n</code></pre>"},{"location":"Linux/ssh.html#4-something-to-be-improved","title":"4. Something To be Improved","text":"<ol> <li>sshd won't log to wtmp and btmp file</li> <li>no pam intergration</li> <li>no gssapi support</li> <li>no kerbros support</li> </ol>"},{"location":"blog/index.html","title":"Blog","text":""},{"location":"blog/2024/08/05/deploying-a-cicd-infrastructure-with-docker-compose.html","title":"Deploying a CI/CD Infrastructure with Docker Compose","text":"<p>In this article, I will demonstrate how to deploy a CI/CD infrastructure using Docker Compose. It will require the following components:</p> <ul> <li>a database (postgres)</li> <li>a git server (gitea)</li> <li>a reverse proxy server (openresty)</li> <li>jekins(not finished)</li> </ul>"},{"location":"blog/2024/08/05/deploying-a-cicd-infrastructure-with-docker-compose.html#1-create-two-docker-network-bridges","title":"1. Create Two Docker Network Bridges","text":"<pre><code># For any app that needs to connect to PostgreSQL\ndocker network create --driver bridge postgres_network\n# For the reverse proxy server to connect to the Gitea web service\ndocker network create --driver bridge gitea_network\n</code></pre>"},{"location":"blog/2024/08/05/deploying-a-cicd-infrastructure-with-docker-compose.html#2-start-postgres","title":"2. Start Postgres","text":"<p>Use the Docker Compose file to start a PostgreSQL server, Besides the offical postgres image, Bitnami/PostgreSQL is also a good choice as it provides more flexable control over postgres.</p>"},{"location":"blog/2024/08/05/deploying-a-cicd-infrastructure-with-docker-compose.html#3-config-gitea-database","title":"3. Config Gitea Database","text":"<pre><code># Replace 'giteaPassword' with a strong password\ndocker compose exec -it postgres psql -U postgres -c \"CREATE ROLE gitea WITH LOGIN PASSWORD 'giteaPassword';\"\ndocker compose exec -it postgres psql -U postgres -c \"CREATE DATABASE giteadb WITH OWNER gitea TEMPLATE template0 ENCODING UTF8 LC_COLLATE 'en_US.UTF-8' LC_CTYPE 'en_US.UTF-8';\"\n</code></pre>"},{"location":"blog/2024/08/05/deploying-a-cicd-infrastructure-with-docker-compose.html#4-start-gitea","title":"4. Start Gitea","text":"<p>Use the Docker Compose file to start up gitea server. Remember to replace <code>GITEA__database__PASSWD</code> and <code>SECRET_KEY</code> with strong values., the <code>HTTP_PORT</code> is irrelevant as we will only expose it on the internal <code>gitea_network</code>. To publish the Gitea service with a subpath like <code>/gitea</code>, configure <code>DOMAIN</code> and <code>ROOT_URL</code> accordingly.</p> <p>After Gitea starts, create an administrator account</p> <pre><code>docker compose exec -it gitea su git -c \"gitea admin user create --username &lt;ADMIN&gt; --password &lt;AdminPassword&gt; --email &lt;AdminEmailAddress&gt;\"\n</code></pre>"},{"location":"blog/2024/08/05/deploying-a-cicd-infrastructure-with-docker-compose.html#5-reverse-proxy-server","title":"5. Reverse Proxy Server","text":"<p>I'll use OpenResty as a reverse proxy server. It's like an Nginx server with many plugins, so I won't need to recompile Nginx for additional functionality.</p> <p>First, create an Nginx configuration file. Similar to the official Nginx Docker image, the OpenResty Docker image allows users to customize the configuration file by overwriting <code>/etc/nginx/conf.d/default.conf</code> within the container. The main configuration file <code>/usr/local/openresty/nginx/conf/nginx.conf</code> has an entry <code>include conf.d/*.conf</code>. Here's my configuration file:</p> <pre><code># The default Docker DNS resolver, required for Nginx to resolve Gitea container IP\nresolver 127.0.0.11 valid=30s;\naccess_log /var/log/nginx/access.log ;\nerror_log /var/log/nginx/error.log ;\nserver {\n   listen 443;\n   server_name _;\n   charset utf-8;\n   # gitea service will also need a 'v2' sub path\n   location ~ ^/(gitea|v2)($|/) {\n      client_max_body_size 512M;\n      rewrite ^ $request_uri;\n      rewrite ^(/gitea)?(/.*) $2 break;\n      proxy_pass http://gitea:3000$uri;\n      proxy_set_header Connection $http_connection;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto $scheme;\n   }\n}\n</code></pre> <p>Then, start the OpenResty server using the Compose file. After that, we can access the gitea server using the accout we created</p>"},{"location":"blog/2024/08/05/deploying-a-cicd-infrastructure-with-docker-compose.html#6-jenkins","title":"6. Jenkins","text":"<p>...</p>"},{"location":"blog/archive/2024.html","title":"2024","text":""}]}